<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp ‚Üî amoCRM MVP - –¢–µ—Å—Ç–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header { text-align: center; margin-bottom: 30px; }
        .status { display: flex; justify-content: space-around; margin-bottom: 30px; }
        .status-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 150px;
        }
        .status-card.active { background: #d4edda; border: 1px solid #c3e6cb; }
        .status-card.error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input, textarea, button {
            width: 100%; padding: 10px; border: 1px solid #ddd;
            border-radius: 5px; font-size: 16px;
        }
        button { background: #007bff; color: white; border: none; cursor: pointer; font-weight: 500; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .two-columns {
            display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;
        }
        .dialogs, .messages {
            max-height: 400px; overflow-y: auto; border: 1px solid #ddd;
            border-radius: 5px; padding: 10px;
        }
        .dialog-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .dialog-item:hover { background: #f8f9fa; }
        .message { margin-bottom: 10px; padding: 10px; border-radius: 10px; }
        .message.incoming { background: #e9ecef; margin-right: 20px; }
        .message.outgoing { background: #007bff; color: white; margin-left: 20px; }
        .response {
            margin: 20px auto; max-width: 800px; padding: 15px;
            border-radius: 5px; font-family: monospace; font-size: 14px;
            overflow-x: auto;
        }
        .response.success { background: #d4edda; border: 1px solid #c3e6cb; }
        .response.error { background: #f8d7da; border: 1px solid #f5c6cb; }
        @media (max-width: 768px) {
            .two-columns { grid-template-columns: 1fr; gap: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± WhatsApp ‚Üî amoCRM MVP</h1>
            <p>–¢–µ—Å—Ç–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∏–∞–ª–æ–≥–æ–≤</p>
        </div>

        <div class="status">
            <div class="status-card" id="server-status"><h4>üñ• –°–µ—Ä–≤–µ—Ä</h4><div id="server-text">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div></div>
            <div class="status-card" id="gupshup-status"><h4>üì± Gupshup</h4><div id="gupshup-text">–û–∂–∏–¥–∞–Ω–∏–µ</div></div>
            <div class="status-card" id="amo-status"><h4>üè¢ amoCRM</h4><div id="amo-text">–û–∂–∏–¥–∞–Ω–∏–µ</div></div>
        </div>

        <div class="form-group">
            <h3>üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
            <div style="display: grid; grid-template-columns: 1fr 2fr 100px; gap: 10px;">
                <input type="text" id="phone" placeholder="+79001234567" value="+79001234567">
                <textarea id="message" rows="2">–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</textarea>
                <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>

        <div id="response" class="response" style="display:none;"></div>

        <div class="two-columns">
            <div>
                <h3>üí¨ –î–∏–∞–ª–æ–≥–∏</h3>
                <button onclick="loadDialogs()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                <div id="dialogs" class="dialogs">
                    <div style="text-align:center;padding:20px;color:#666;">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫"</div>
                </div>
            </div>
            <div>
                <h3>üìú –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                <div id="current-phone" style="margin-bottom:10px;font-weight:500;"></div>
                <div id="messages" class="messages">
                    <div style="text-align:center;padding:20px;color:#666;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥</div>
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ -->
        <div style="text-align:center;margin:30px 0;">
            <button id="test-btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é</button>
        </div>
        <pre id="test-output" class="response" style="display:none;"></pre>
    </div>

    <script>
        const API_BASE = window.location.origin;

        document.addEventListener('DOMContentLoaded', () => {
            checkServerStatus();
            setInterval(checkServerStatus, 60000);
            setInterval(loadDialogs, 30000);
        });

        async function checkServerStatus() {
            try {
                const r = await fetch(`${API_BASE}/health`);
                const data = await r.json();
                updateStatus('server','active',`–†–∞–±–æ—Ç–∞–µ—Ç\nUptime: ${Math.floor(data.uptime)}s`);
            } catch {
                updateStatus('server','error','–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
            }
        }
        function updateStatus(id,status,text) {
            document.getElementById(`${id}-status`).className = `status-card ${status}`;
            document.getElementById(`${id}-text`).textContent = text;
        }

        async function sendMessage() {
            const btn = event.target;
            const phone = document.getElementById('phone').value.trim();
            const message = document.getElementById('message').value.trim();
            if(!phone||!message){ showResponse('error','–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ'); return; }
            btn.disabled=true; btn.textContent='–û—Ç–ø—Ä–∞–≤–∫–∞...';
            updateStatus('gupshup','','–û—Ç–ø—Ä–∞–≤–∫–∞...');
            try {
                const r = await fetch(`${API_BASE}/api/send-message`,{
                    method:'POST',headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({phone,message})
                });
                const j=await r.json();
                if(j.success){
                    showResponse('success',`‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ\n${JSON.stringify(j,0,2)}`);
                    updateStatus('gupshup','active','–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
                    updateStatus('amo','active','–û–±–Ω–æ–≤–ª–µ–Ω–æ');
                    document.getElementById('message').value='';
                    setTimeout(loadDialogs,1000);
                } else {
                    showResponse('error',`‚ùå –û—à–∏–±–∫–∞\n${j.error||''}`);
                    updateStatus('gupshup','error','–û—à–∏–±–∫–∞');
                }
            } catch(e){
                showResponse('error',`‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞\n${e.message}`);
                updateStatus('gupshup','error','–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
            } finally {
                btn.disabled=false; btn.textContent='–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            }
        }

        async function loadDialogs() {
            const el=document.getElementById('dialogs');
            el.innerHTML='<div style="text-align:center;padding:20px;">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                const r=await fetch(`${API_BASE}/api/dialogs`);
                const d=await r.json();
                el.innerHTML = d.length
                    ? d.map(x=>`<div class="dialog-item" onclick="loadMessages('${x.phone}')">
                        <div>${x.phone}</div><small>–°–æ–æ–±—â–µ–Ω–∏–π: ${x.messageCount}</small>
                      </div>`).join('')
                    : '<div style="text-align:center;padding:20px;color:#666;">–î–∏–∞–ª–æ–≥–æ–≤ –Ω–µ—Ç</div>';
            } catch {
                el.innerHTML='<div style="text-align:center;padding:20px;color:#e74c3c;">–û—à–∏–±–∫–∞</div>';
            }
        }

        async function loadMessages(phone){
            document.getElementById('current-phone').textContent=`–î–∏–∞–ª–æ–≥: ${phone}`;
            const el=document.getElementById('messages');
            el.innerHTML='<div style="text-align:center;padding:20px;">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try{
                const r=await fetch(`${API_BASE}/api/dialog/${encodeURIComponent(phone)}`);
                const d=await r.json();
                el.innerHTML = d.messages.length
                    ? d.messages.map(m=>`<div class="message ${m.type}">${m.message}<br><small>${new Date(m.timestamp).toLocaleString()}</small></div>`).join('')
                    : '<div style="text-align:center;padding:20px;color:#666;">–ü—É—Å—Ç–æ</div>';
                el.scrollTop=el.scrollHeight;
            }catch{
                el.innerHTML='<div style="text-align:center;padding:20px;color:#e74c3c;">–û—à–∏–±–∫–∞</div>';
            }
        }

        function showResponse(type,text){
            const r=document.getElementById('response');
            r.className=`response ${type}`; r.textContent=text; r.style.display='block';
            if(type==='success') setTimeout(()=>r.style.display='none',10000);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        document.getElementById('test-btn').addEventListener('click', async () => {
            const btn=document.getElementById('test-btn');
            const out=document.getElementById('test-output');
            btn.disabled=true; btn.textContent='–ü—Ä–æ–≤–µ—Ä–∫–∞...';
            out.style.display='none'; out.textContent='';
            try {
                const r=await fetch(`${API_BASE}/api/test-connection`);
                const j=await r.json();
                out.textContent=JSON.stringify(j,null,2);
                out.className=j.gupshup?.error||j.amo?.error?'response error':'response success';
            }catch(e){
                out.textContent='–û—à–∏–±–∫–∞: '+e.message; out.className='response error';
            }finally{
                out.style.display='block'; btn.disabled=false; btn.textContent='–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é';
            }
        });
    </script>
</body>
</html>
