#!/bin/bash

echo "üöÄ WhatsApp ‚Üî Gupshup ‚Üî amoCRM MVP"
echo "=================================="

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Node.js
check_node() {
    if ! command -v node &> /dev/null; then
        echo "‚ùå Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
        echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Node.js –≤–µ—Ä—Å–∏–∏ 16+ —Å https://nodejs.org"
        exit 1
    fi

    NODE_VERSION=$(node -v | sed 's/v//' | cut -d. -f1)
    if [ "$NODE_VERSION" -lt 16 ]; then
        echo "‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è Node.js –≤–µ—Ä—Å–∏–∏ 16+, —Ç–µ–∫—É—â–∞—è: $(node -v)"
        exit 1
    fi

    echo "‚úÖ Node.js $(node -v) —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
}

# –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
install_deps() {
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    npm install

    if [ $? -ne 0 ]; then
        echo "‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
        exit 1
    fi

    echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ .env
check_env() {
    if [ ! -f .env ]; then
        echo "‚ö†Ô∏è  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω"
        echo "–°–æ–∑–¥–∞–π—Ç–µ .env —Ñ–∞–π–ª –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–º–µ—Ä–∞:"
        echo "cp .env.example .env"
        echo "nano .env"
        return 1
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    if ! grep -q "GUPSHUP_API_KEY=–≤–∞—à" .env || ! grep -q "AMO_SUBDOMAIN=–≤–∞—à" .env; then
        echo "‚úÖ –§–∞–π–ª .env –Ω–∞–π–¥–µ–Ω"
        return 0
    else
        echo "‚ö†Ô∏è  –§–∞–π–ª .env —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∏–º–µ—Ä—ã –∑–Ω–∞—á–µ–Ω–∏–π"
        echo "–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:"
        echo "nano .env"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ –∑–∞–ø—É—Å–∫–∞
select_mode() {
    echo ""
    echo "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∑–∞–ø—É—Å–∫–∞:"
    echo "1) –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (nodemon —Å –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º)"
    echo "2) –ü—Ä–æ–¥–∞–∫—à–µ–Ω (–æ–±—ã—á–Ω—ã–π –∑–∞–ø—É—Å–∫)"
    echo "3) –ü—Ä–æ–¥–∞–∫—à–µ–Ω (PM2 –¥–µ–º–æ–Ω)"
    echo "4) –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫"
    echo ""
    read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä (1-4): " choice

    case $choice in
        1)
            echo "üîß –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏..."
            if command -v nodemon &> /dev/null; then
                npm run dev
            else
                echo "Installing nodemon..."
                npm install -g nodemon
                npm run dev
            fi
            ;;
        2)
            echo "üöÄ –ó–∞–ø—É—Å–∫ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω —Ä–µ–∂–∏–º–µ..."
            NODE_ENV=production npm start
            ;;
        3)
            echo "‚öôÔ∏è –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2..."
            if ! command -v pm2 &> /dev/null; then
                echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2..."
                npm install -g pm2
            fi
            npm run pm2
            echo "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PM2:"
            echo "  pm2 status         - —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
            echo "  pm2 logs           - –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤"
            echo "  pm2 restart all    - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫"
            echo "  pm2 stop all       - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞"
            ;;
        4)
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫..."
            echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"
            exit 0
            ;;
        *)
            echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
            exit 1
            ;;
    esac
}

# –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å
main() {
    echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã..."
    check_node

    if [ ! -d "node_modules" ]; then
        install_deps
    else
        echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    fi

    if ! check_env; then
        echo ""
        echo "‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –≥–æ—Ç–æ–≤—ã. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ .env —Ñ–∞–π–ª –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞."
        exit 1
    fi

    echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã"
    select_mode
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ Ctrl+C
trap 'echo "\nüëã –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã..."; exit 0' INT

# –ó–∞–ø—É—Å–∫
main
