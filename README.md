# WhatsApp ‚Üî AmoCRM Integration MVP

–ü—Ä–æ—Å—Ç–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–µ–∂–¥—É Gupshup WhatsApp API –∏ AmoCRM API v4 —Å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

## ‚ú® –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏** —Å Gupshup –∏ AmoCRM API v4
- ‚úÖ **OAuth 2.0 –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–æ–≤ AmoCRM
- ‚úÖ **–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** —Å –∫–Ω–æ–ø–∫–∞–º–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- ‚úÖ **–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π** —á–µ—Ä–µ–∑ WhatsApp API
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ** –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏ —Å–¥–µ–ª–æ–∫ –≤ AmoCRM
- ‚úÖ **Webhook –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö** —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç Gupshup
- ‚úÖ **Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è** –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
- ‚úÖ **Nginx reverse proxy** —Å SSL –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π

## üöÄ –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫

1. **–ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ –ø–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–ø–∫—É:**
   ```bash
   cd wabapp-mvp
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ .env —Ñ–∞–π–ª–µ** (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å –≤–∞—à–∏–º–∏ –∫–ª—é—á–∞–º–∏)

3. **–ó–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Makefile:**
   ```bash
   make
   # –í—ã–±—Ä–∞—Ç—å –ø—É–Ω–∫—Ç 2 –¥–ª—è —Å–±–æ—Ä–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞
   ```

4. **–û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ:**
   ```
   http://bondio.ru (–∏–ª–∏ http://localhost:3001 –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
   ```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

–í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ `.env` —Ñ–∞–π–ª–µ:

```env
# Gupshup WhatsApp API
GUPSHUP_API_KEY=sk_0e53c54f994f4e50a279e565aa1572ee
GUPSHUP_APP_NAME=test204
GUPSHUP_SOURCE_NUMBER=79522829086

# amoCRM API credentials
AMO_SUBDOMAIN=bondarik
AMO_CLIENT_ID=d96bc93f-1fb0-452f-890a-70682047c271
AMO_CLIENT_SECRET=BAJmwJrEV8s7Lnlrm8tuPod9rlOxljVRnTo5dmFFgoYIMJGyq6WlEZ3EIngadbBY
AMO_REDIRECT_URI=http://bondio.ru/api/amo/callback
```

### Webhook –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

1. **–í Gupshup –ø–∞–Ω–µ–ª–∏** —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook URL:
   ```
   http://bondio.ru/webhook/gupshup
   ```

2. **–í AmoCRM** –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º redirect_uri

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Ç–µ—Å—Ç—ã:

### 1. –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- –ù–∞–∂–∞—Ç—å **"–¢–µ—Å—Ç Gupshup API"** - –ø—Ä–æ–≤–µ—Ä–∏—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Gupshup API
- –ù–∞–∂–∞—Ç—å **"–¢–µ—Å—Ç AmoCRM API"** - –ø—Ä–æ–≤–µ—Ä–∏—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤ AmoCRM

### 2. OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è AmoCRM
- –ù–∞–∂–∞—Ç—å **"–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ AmoCRM"** –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- –ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### 3. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- –í–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã +7, 8, –∏–ª–∏ —Ü–∏—Ñ—Ä—ã)
- –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- –ù–∞–∂–∞—Ç—å **"–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ WhatsApp"**

### 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ/–ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è:
  - –ö–æ–Ω—Ç–∞–∫—Ç –≤ AmoCRM
  - –°–¥–µ–ª–∫–∞ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –∫–æ–Ω—Ç–∞–∫—Ç—É
  - –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
wabapp-mvp/
‚îú‚îÄ‚îÄ app.py                  # –û—Å–Ω–æ–≤–Ω–æ–µ Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ requirements.txt        # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ .env                   # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ Dockerfile             # Docker –æ–±—Ä–∞–∑
‚îú‚îÄ‚îÄ docker-compose.yml     # –ú–Ω–æ–≥–æ–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
‚îú‚îÄ‚îÄ nginx.conf             # Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ Makefile              # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–º
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îú‚îÄ‚îÄ base.html         # –ë–∞–∑–æ–≤—ã–π HTML —à–∞–±–ª–æ–Ω
‚îÇ   ‚îî‚îÄ‚îÄ index.html        # –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
‚îú‚îÄ‚îÄ static/
‚îÇ   ‚îú‚îÄ‚îÄ style.css         # CSS —Å—Ç–∏–ª–∏
‚îÇ   ‚îî‚îÄ‚îÄ script.js         # JavaScript —Ñ—É–Ω–∫—Ü–∏–∏
‚îî‚îÄ‚îÄ README.md             # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

## üîå API Endpoints

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- `GET /api/test/gupshup` - –¢–µ—Å—Ç Gupshup API
- `GET /api/test/amocrm` - –¢–µ—Å—Ç AmoCRM API
- `GET /api/status` - –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã

### –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- `POST /api/send-message` - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ WhatsApp

### AmoCRM OAuth
- `GET /api/amo/auth` - –ù–∞—á–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
- `GET /api/amo/callback` - OAuth callback

### Webhooks
- `POST /webhook/gupshup` - –í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç Gupshup

## üê≥ Docker —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
docker build -t wabapp .
docker run -p 3001:3001 --env-file .env wabapp
```

### –ü—Ä–æ–¥–∞–∫—à–Ω —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
```bash
# –ó–∞–ø—É—Å–∫ —Å Nginx
make up  # –∏–ª–∏ docker compose up -d --build
```

## ‚öôÔ∏è Makefile –∫–æ–º–∞–Ω–¥—ã

```bash
make          # –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é
make up       # –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
make down     # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
make logs     # –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
make clean    # –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã
make rebuild  # –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞
```

## üîç –õ–æ–≥–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- **–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–õ–æ–≥–∏ –æ–ø–µ—Ä–∞—Ü–∏–π"
- **Docker –ª–æ–≥–∏**: `make logs` –∏–ª–∏ `docker compose logs -f`
- **Nginx –ª–æ–≥–∏**: –í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ nginx –≤ `/var/log/nginx/`

## üö® Troubleshooting

### Gupshup API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞ –≤ .env
2. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ –≤ Gupshup –ø–∞–Ω–µ–ª–∏
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Gupshup

### AmoCRM –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å client_id –∏ client_secret –≤ .env
2. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ redirect_uri —Å–æ–≤–ø–∞–¥–∞–µ—Ç –≤ .env –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ AmoCRM
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞ –≤ AmoCRM

### –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω
2. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –ø–æ—Ä—Ç—ã 80, 443, 3001 —Å–≤–æ–±–æ–¥–Ω—ã
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º –ø—Ä–æ–µ–∫—Ç–∞

### –í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook URL –≤ Gupshup: `http://bondio.ru/webhook/gupshup`
2. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –¥–æ–º–µ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ webhook

## üìû –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–ª–∏ `make logs`
2. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ

## üéØ –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞

1. ‚úÖ –û—Ç–∫—Ä—ã—Ç—å http://bondio.ru –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. ‚úÖ –ù–∞–∂–∞—Ç—å "–¢–µ—Å—Ç Gupshup API" - –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å "success"
3. ‚úÖ –ù–∞–∂–∞—Ç—å "–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ AmoCRM" –∏ –ø—Ä–æ–π—Ç–∏ OAuth
4. ‚úÖ –ù–∞–∂–∞—Ç—å "–¢–µ—Å—Ç AmoCRM API" - –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞
5. ‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Å–≤–æ–π –Ω–æ–º–µ—Ä WhatsApp
6. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤ AmoCRM —Å–æ–∑–¥–∞–ª–∏—Å—å –∫–æ–Ω—Ç–∞–∫—Ç –∏ —Å–¥–µ–ª–∫–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –†–∞–±–æ—á–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è WhatsApp ‚Üî AmoCRM –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üéâ
